<template component="message-list">
  <div class="flex flex-col h-full">
    <div class="overflow-y-scroll flex-grow pb-2">
      <template if="messages.length">
        <div class="flex flex-col gap-2">
          <template for="message of messages">
            <div
              class="flex items-center gap-2"
              class-jusstify-end="message.role === 'user'"
            >
              <button
                on-click="setText(message.contents)"
                class="rounded text-sm"
                class-bg-blue-500.text-white.px-2.py-1="message.role === 'user' || !message.role"
                style-max-width="'80%'"
              >
                {{ message.contents }}
              </button>
              <button
                class="text-xs opacity-0 hover:opacity-100 focus:opacity-100"
                on-click="removeMessage(message)"
              >
                &times;
              </button>
            </div>
          </template>
        </div>
      </template>
      <span ref="lastMessage"></span>
    </div>
    <div class="flex items-center justify-end pt-2 gap-2">
      <lucide-icon
        size="16"
        class-hidden="!thinking"
        class-animate-spin="thinking"
        bind-icon="thinking ? 'loader-circle' : 'sparkles'"
      ></lucide-icon>
      <button
        on-click="suggestAnswer()"
        class="flex items-center space-x-2 p-1"
      >
        <lucide-icon size="16" icon="sparkles"></lucide-icon>
        <span class="text-sm">Suggest an answer</span>
      </button>
      <button on-click="newQuestion()" class="flex items-center space-x-2 p-1">
        <lucide-icon size="16" icon="circle-help"></lucide-icon>
        <span class="text-sm">Ask me anything</span>
      </button>
    </div>
  </div>

  <script setup>
    import { effect, templateRef } from "@li3/web";
    import useStore from "@/store.js";

    export default function () {
      const lastMessage = templateRef("lastMessage");
      const { select, store } = useStore();
      const { setText, newQuestion, suggestAnswer, removeMessage } = store;
      const messages = select((s) => s.history || []);
      const thinking = select((s) => s.thinking);
      const scrollDown = () => lastMessage.value?.scrollIntoView();

      effect(() => {
        if (messages.value && lastMessage.value) {
          setTimeout(scrollDown, 10);
        }
      });

      return {
        messages,
        setText,
        newQuestion,
        suggestAnswer,
        removeMessage,
        thinking,
      };
    }
  </script>
</template>
